// prisma/global.schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../src/prisma-global"
}

datasource db {
  provider = "postgresql"
  // use GLOBAL_DATABASE_URL if you set it; otherwise you can point this to DATABASE_URL
  url      = env("DATABASE_URL")
}

// Enums (map to existing Postgres enums)
enum OrgType {
  SCHOOL       @map("school")
  BUS_COMPANY  @map("bus_company")
  PARENT_ORG   @map("parent_org")

  @@map("org_type")
}

enum RoleType {
  SCHOOL_STAFF @map("school_staff")
  BUS_COMPANY  @map("bus_company")
  ADMIN        @map("admin")
  FINANCE      @map("finance")

  @@map("role_type")
}

enum DataConnectionMode {
  SAAS
  BYODB

  @@map("data_connection_mode")
}

// Tables (map to existing snake_case tables)
model Tenants {
  id               String            @id @default(uuid())
  name             String
  slug             String            @unique
  created_at       DateTime          @default(now())
  updated_at       DateTime          @default(now()) @db.Timestamptz(6)

  organizations    Organizations[]
  users            Users[]
  partnerships     Partnerships[]
  data_connections DataConnections[]
  trip_registry    TripRegistry[]

  @@map("tenants")
}

model Organizations {
  id            String   @id @default(uuid())
  tenant_id     String
  name          String
  type          OrgType
  code          String?
  parent_org_id String?
  created_at    DateTime @default(now())
  updated_at    DateTime @default(now()) @db.Timestamptz(6)

  tenants       Tenants  @relation(fields: [tenant_id], references: [id])
  user_roles    UserRoles[]

  // relations used in queries
  partnerships_SchoolPartnership     Partnerships[] @relation("SchoolPartnership")
  partnerships_BusCompanyPartnership Partnerships[] @relation("BusCompanyPartnership")

  trip_registry_SchoolTrips  TripRegistry[] @relation("SchoolTrips")
  trip_registry_CompanyTrips TripRegistry[] @relation("CompanyTrips")

  @@unique([tenant_id, code])
  @@index([tenant_id])
  @@map("organizations")
}

model Users {
  id             String   @id // mirrors auth.users.id
  tenant_id      String?
  email          String   @unique
  full_name      String?
  is_active      Boolean  @default(true)
  legacy_user_id Int?     @unique
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now()) @db.Timestamptz(6)

  tenants    Tenants?   @relation(fields: [tenant_id], references: [id])
  user_roles UserRoles[]

  @@index([tenant_id])
  @@map("users")
}

model UserRoles {
  user_id    String
  org_id     String
  role       RoleType
  is_default Boolean  @default(false)
  created_at DateTime @default(now())

  users         Users         @relation(fields: [user_id], references: [id])
  organizations Organizations @relation(fields: [org_id], references: [id])

  @@id([user_id, org_id, role])
  @@index([org_id])
  @@map("user_roles")
}

model Partnerships {
  id             String   @id @default(uuid())
  tenant_id      String
  school_org_id  String
  bus_company_id String
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now()) @db.Timestamptz(6)

  tenants       Tenants       @relation(fields: [tenant_id], references: [id])
  organizations_school Organizations @relation("SchoolPartnership", fields: [school_org_id], references: [id])
  organizations_bus    Organizations @relation("BusCompanyPartnership", fields: [bus_company_id], references: [id])

  @@unique([tenant_id, school_org_id, bus_company_id])
  @@index([tenant_id])
  @@map("partnerships")
}

model DataConnections {
  id               String             @id @default(uuid())
  tenant_id        String
  org_id           String
  mode             DataConnectionMode
  db_host          String?
  db_port          Int?
  db_name          String?
  db_user          String?
  db_schema        String?
  db_ssl           Boolean?
  vault_secret_id  String?
  last_verified_at DateTime?
  is_active        Boolean            @default(true)
  created_at       DateTime           @default(now())
  updated_at       DateTime           @default(now()) @db.Timestamptz(6)

  tenants        Tenants        @relation(fields: [tenant_id], references: [id])
  organizations  Organizations  @relation(fields: [org_id], references: [id])
  trip_registry  TripRegistry[]

  @@unique([org_id, mode])
  @@index([tenant_id])
  @@index([org_id])
  @@map("data_connections")
}

model TripRegistry {
  id                 String   @id @default(uuid())
  tenant_id          String
  trip_code          String
  school_org_id      String
  bus_company_org_id String?
  data_connection_id String
  external_ref       String?
  created_at         DateTime @default(now())
  updated_at         DateTime @default(now()) @db.Timestamptz(6)

  tenants           Tenants           @relation(fields: [tenant_id], references: [id])
  organizations_school  Organizations @relation("SchoolTrips", fields: [school_org_id], references: [id])
  organizations_company Organizations? @relation("CompanyTrips", fields: [bus_company_org_id], references: [id])
  data_connections  DataConnections   @relation(fields: [data_connection_id], references: [id])

  @@unique([tenant_id, trip_code])
  @@index([tenant_id])
  @@index([school_org_id])
  @@index([bus_company_org_id])
  @@map("trip_registry")
}
